# @ 文件引用 - 弹出式选择指南

## 概述

现在当你输入 `@` 引用文件时，如果有多个匹配的文件，系统会自动显示一个**弹出式选择菜单**，让你直观地选择想要的文件。

## 🎯 两种模式

### 模式 1: 增强模式（prompt-toolkit）

当安装了 `prompt-toolkit` 后，你将获得 IDE 级别的体验：

#### 特性

- ✅ 输入 `@` 后立即显示下拉补全菜单
- ✅ 实时过滤和搜索
- ✅ 上下箭头选择文件
- ✅ Tab 键补全
- ✅ 鼠标支持（可点击选择）
- ✅ Ctrl+Space 手动触发补全

#### 使用方法

```
👤 你: @
```

立即显示文件列表（类似 VS Code 的补全菜单）：

```
🐍 agent_config.py (3.2K)
🐍 agent_workflow.py (8.5K)
📝 README.md (12.3K)
...
```

继续输入过滤：

```
👤 你: @agent
```

自动过滤显示：

```
🐍 agent_config.py (3.2K)
🐍 agent_llm.py (674B)
🐍 agent_memory.py (2.6K)
🐍 agent_nodes.py (55.2K)
...
```

### 模式 2: 降级模式（传统弹出框）

如果没有 `prompt-toolkit`，系统会使用改进的传统弹出选择：

#### 特性

- ✅ 检测到多个匹配时自动弹出选择框
- ✅ 美观的表格式显示
- ✅ 高亮显示匹配部分
- ✅ 数字快速选择
- ✅ 支持跳过

#### 使用方法

```
👤 你: @agent
```

自动弹出选择框：

```
┌────────────────────────────────────────────────────────────────────┐
│ 🔍 找到 4 个匹配 '@agent' 的文件                                    │
├────────────────────────────────────────────────────────────────────┤
│  1. 🐍 [agent]_config.py                                            │
│  2. 🐍 [agent]_llm.py                                               │
│  3. 🐍 [agent]_memory.py                                            │
│  4. 🐍 [agent]_nodes.py                                             │
└────────────────────────────────────────────────────────────────────┘

💡 提示: 输入数字选择文件，或按 Enter 使用第一个匹配
👉 选择文件 (数字/Enter 用第一个/s 跳过): 
```

#### 选择选项

| 输入 | 动作 |
|------|------|
| `1` | 选择第一个文件 |
| `2` | 选择第二个文件 |
| `Enter` | 使用第一个文件（默认） |
| `s` | 跳过，保持原样 |

## 💡 使用场景

### 场景 1: 模糊搜索

当你只记得文件名的一部分时：

```
👤 你: @cfg
```

显示所有包含 "cfg" 的文件：
- agent_config.py
- mcp_config.json
- .cursor/rules/...

你可以从中选择想要的文件。

### 场景 2: 多文件引用

在一次输入中引用多个文件：

```
👤 你: 比较 @agent_config 和 @agent_llm 的差异
```

系统会依次为每个 `@` 引用显示选择菜单。

### 场景 3: 不确定文件名

当你不确定确切的文件名时：

```
👤 你: @test
```

显示所有测试文件，让你选择：
- test_demo.py
- test_file_reference.py
- test_smart_file_input.py
- ...

## 🎨 视觉效果

### 高亮显示

在降级模式中，匹配的部分会用方括号标记：

```
[agent]_config.py      # 匹配 'agent'
agent_[config].py      # 匹配 'config'
```

### 文件图标

不同类型的文件显示不同的图标：

- 🐍 Python 文件
- 📝 Markdown 文件
- 📋 JSON 文件
- ⚙️ YAML/配置文件
- 📁 目录

## ⌨️ 快捷键总结

### 增强模式 (prompt-toolkit)

| 快捷键 | 功能 |
|--------|------|
| `↑` `↓` | 导航文件列表 |
| `Tab` | 补全当前选中项 |
| `Enter` | 确认选择 |
| `Ctrl+Space` | 手动触发补全菜单 |
| `Ctrl+C` | 取消输入 |

### 降级模式 (传统弹出框)

| 输入 | 功能 |
|------|------|
| `数字` | 选择对应编号的文件 |
| `Enter` | 使用第一个匹配 |
| `s` | 跳过当前选择 |

## 🚀 安装增强功能

获得最佳体验：

```bash
# 方法 1: 使用安装脚本
python install_prompt_toolkit.py

# 方法 2: 手动安装
pip install prompt-toolkit>=3.0.0
```

验证安装：

```bash
python -c "import prompt_toolkit; print('✅ 已安装')"
```

## 🎯 实战示例

### 示例 1: 查看配置文件

```
👤 你: @cfg
[弹出选择框]
👉 选择文件: 1

✅ 已选择: 🐍 agent_config.py

# 继续输入
👤 你: @agent_config.py 有哪些配置项？
🤖 助手: 配置文件包含以下配置项...
```

### 示例 2: 比较两个文件

```
👤 你: 比较 @old 和 @new 的差异

[为 @old 弹出选择框]
👉 选择文件: 1
✅ 已选择: 📄 old_version.txt

[为 @new 弹出选择框]
👉 选择文件: 1
✅ 已选择: 📄 new_version.txt

# 系统会自动替换为完整文件名
👤 你: 比较 @old_version.txt 和 @new_version.txt 的差异
🤖 助手: 两个文件的主要差异是...
```

### 示例 3: 快速选择默认值

```
👤 你: @read 这个文件
[弹出选择框，显示 README.md 在第一位]
👉 选择文件: [直接按 Enter]
✅ 已选择: 📝 README.md
```

## 🔧 高级技巧

### 技巧 1: 使用缩写

利用模糊匹配，输入缩写快速定位：

- `@cfg` → config 文件
- `@wkf` → workflow 文件
- `@ui` → UI 文件

### 技巧 2: 路径补全

输入部分路径也会触发补全：

```
👤 你: @docs/
[显示 docs 目录下的文件]
```

### 技巧 3: 跳过不需要的选择

如果输入的是精确文件名，选择时按 `s` 跳过：

```
👤 你: @README.md 总结
# 如果只有一个 README.md，会自动选择，无需手动操作
```

## 📊 对比：旧 vs 新

| 特性 | 旧版本 | 新版本 |
|------|--------|--------|
| 多文件匹配 | 显示列表，手动输入数字 | 弹出式选择框，更直观 |
| 视觉效果 | 简单列表 | 表格边框 + 图标 + 高亮 |
| 默认行为 | 必须选择 | 可按 Enter 使用第一个 |
| 跳过选择 | 不支持 | 按 `s` 跳过 |
| 实时补全 | 不支持 | 支持（增强模式） |

## 🐛 故障排除

### 问题 1: 弹出框显示不正常

**可能原因**: 终端编码问题

**解决方案**:
```bash
# Windows
chcp 65001

# Linux/Mac
export LANG=zh_CN.UTF-8
```

### 问题 2: 没有弹出选择

**可能原因**: 只有一个匹配，自动选择了

**解决方案**: 这是预期行为，查看提示信息确认选择的文件

### 问题 3: 想要传统全屏选择器

**解决方案**: 输入单独的 `@` 会启动传统的全屏文件选择器

```
👤 你: @
🎯 启动文件选择器...
[全屏文件列表]
```

## 📚 相关文档

- [UPGRADE_GUIDE.md](../UPGRADE_GUIDE.md) - 功能升级指南
- [SMART_FILE_REFERENCE.md](SMART_FILE_REFERENCE.md) - 完整功能文档
- [demo_smart_file_input.py](../demo_smart_file_input.py) - 交互式演示

---

**最后更新**: 2025-10-22  
**版本**: 1.1.0

