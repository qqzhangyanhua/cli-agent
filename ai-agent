#!/usr/bin/env python3
"""
AIæ™ºèƒ½ä½“ç»ˆç«¯æ§åˆ¶å·¥å…· - CLIç‰ˆæœ¬

ä¸€ä¸ªæ™ºèƒ½çš„ç»ˆç«¯åŠ©æ‰‹ï¼Œæ”¯æŒè‡ªç„¶è¯­è¨€æ‰§è¡Œå‘½ä»¤ã€æ–‡ä»¶æ“ä½œã€å¾…åŠç®¡ç†å’Œå¯¹è¯è®°å¿†ã€‚

ä½¿ç”¨ç¤ºä¾‹:
    # åŸºç¡€åŠŸèƒ½
    ai-agent                          # äº¤äº’æ¨¡å¼
    ai-agent "åˆ—å‡ºæ‰€æœ‰Pythonæ–‡ä»¶"     # å•æ¬¡æ‰§è¡Œ
    ai-agent --version                # æŸ¥çœ‹ç‰ˆæœ¬
    ai-agent --help                   # æŸ¥çœ‹å¸®åŠ©

    # å¾…åŠäº‹é¡¹ç®¡ç†
    ai-agent "ä»Šå¤©18ç‚¹ç»™é™ˆé¾™æ‰“ç”µè¯"     # æ·»åŠ å¾…åŠ
    ai-agent "æ˜å¤©ä¸Šåˆ10ç‚¹å¼€ä¼š"         # æ·»åŠ å¾…åŠ
    ai-agent "æé†’æˆ‘åå¤©ä¸‹åˆ2ç‚¹äº¤æŠ¥å‘Š"  # æ·»åŠ å¾…åŠ
    ai-agent "ä»Šå¤©æœ‰ä»€ä¹ˆè¦åšçš„"         # æŸ¥è¯¢å¾…åŠ
    ai-agent "æ˜å¤©æœ‰ä»€ä¹ˆå®‰æ’"           # æŸ¥è¯¢å¾…åŠ
    ai-agent "æœªæ¥3å¤©æœ‰ä»€ä¹ˆä»»åŠ¡"        # æŸ¥è¯¢å¾…åŠ
    ai-agent "æœç´¢é™ˆé¾™ç›¸å…³çš„å¾…åŠ"       # æœç´¢å¾…åŠ

    # å…¶ä»–åŠŸèƒ½
    ai-agent "ç”Ÿæˆgit commitæ¶ˆæ¯"     # Git commitç”Ÿæˆ
    ai-agent "ä»€ä¹ˆæ˜¯Python"           # çŸ¥è¯†é—®ç­”
"""

import sys
import os
import argparse
from pathlib import Path

# æ·»åŠ é¡¹ç›®ç›®å½•åˆ°Pythonè·¯å¾„ï¼ˆæ”¯æŒä»ä»»ä½•ä½ç½®è¿è¡Œï¼‰
SCRIPT_DIR = Path(__file__).parent.absolute()
if str(SCRIPT_DIR) not in sys.path:
    sys.path.insert(0, str(SCRIPT_DIR))

from agent_config import AgentState
from agent_memory import memory
from agent_workflow import build_agent
from agent_ui import print_header, handle_special_commands
from file_reference_parser import update_working_directory
from interactive_file_selector import (
    interactive_file_select, 
    quick_file_select, 
    update_selector_working_directory
)

__version__ = "1.0.0"


def smart_input_handler(prompt: str = "ğŸ‘¤ ä½ : ") -> str:
    """æ™ºèƒ½è¾“å…¥å¤„ç†å™¨ï¼Œæ”¯æŒ @ æ–‡ä»¶é€‰æ‹©"""
    while True:
        try:
            user_input = input(prompt).strip()
            
            # æ£€æŸ¥æ˜¯å¦åªè¾“å…¥äº† @
            if user_input == "@":
                print("\nğŸ¯ å¯åŠ¨æ–‡ä»¶é€‰æ‹©å™¨...")
                selected_file = interactive_file_select("é€‰æ‹©è¦å¼•ç”¨çš„æ–‡ä»¶")
                if selected_file:
                    # é‡æ–°æç¤ºç”¨æˆ·è¾“å…¥ï¼Œå¹¶é¢„å¡«å……é€‰æ‹©çš„æ–‡ä»¶
                    print(f"\nâœ… å·²é€‰æ‹©æ–‡ä»¶: @{selected_file}")
                    new_prompt = f"ğŸ‘¤ ä½  (å·²é€‰æ‹© @{selected_file}): "
                    additional_input = input(new_prompt).strip()
                    if additional_input:
                        return f"@{selected_file} {additional_input}"
                    else:
                        return f"è¯»å– @{selected_file}"
                else:
                    print("ğŸ”„ ç»§ç»­è¾“å…¥...")
                    continue
            
            # æ£€æŸ¥æ˜¯å¦ä»¥ @ å¼€å¤´ä½†ä¸å®Œæ•´
            elif user_input.startswith("@") and len(user_input) > 1:
                # æå– @ åçš„éƒ¨åˆ†ä½œä¸ºæœç´¢æ¡ä»¶
                search_term = user_input[1:].split()[0]  # å–ç¬¬ä¸€ä¸ªè¯ä½œä¸ºæ–‡ä»¶å
                remaining_text = user_input[len(search_term)+1:].strip()
                
                # å¦‚æœæœç´¢è¯çœ‹èµ·æ¥ä¸å®Œæ•´ï¼Œæä¾›å¿«é€Ÿé€‰æ‹©
                if len(search_term) < 3 or not any(c in search_term for c in './\\'):
                    print(f"\nğŸ” æœç´¢æ–‡ä»¶: '{search_term}'...")
                    selected_file = quick_file_select(search_term)
                    if selected_file:
                        if remaining_text:
                            return f"@{selected_file} {remaining_text}"
                        else:
                            # è¯¢é—®ç”¨æˆ·è¦åšä»€ä¹ˆ
                            action = input(f"ğŸ‘¤ å¯¹ @{selected_file} è¦åšä»€ä¹ˆ? ").strip()
                            if action:
                                return f"@{selected_file} {action}"
                            else:
                                return f"è¯»å– @{selected_file}"
                    else:
                        print("ğŸ”„ ç»§ç»­è¾“å…¥...")
                        continue
            
            # æ™®é€šè¾“å…¥ï¼Œç›´æ¥è¿”å›
            return user_input
            
        except (KeyboardInterrupt, EOFError):
            print("\n\nğŸ‘‹ æ£€æµ‹åˆ°ä¸­æ–­ä¿¡å·ï¼Œé€€å‡ºç¨‹åº...\n")
            sys.exit(0)


def parse_arguments():
    """è§£æå‘½ä»¤è¡Œå‚æ•°"""
    parser = argparse.ArgumentParser(
        prog='ai-agent',
        description='AIæ™ºèƒ½ä½“ç»ˆç«¯æ§åˆ¶å·¥å…· - ä½¿ç”¨è‡ªç„¶è¯­è¨€æ‰§è¡Œç»ˆç«¯å‘½ä»¤',
        epilog='ç¤ºä¾‹: ai-agent "åˆ—å‡ºå½“å‰ç›®å½•çš„æ‰€æœ‰Pythonæ–‡ä»¶"',
        formatter_class=argparse.RawDescriptionHelpFormatter
    )
    
    parser.add_argument(
        'command',
        nargs='*',
        help='è¦æ‰§è¡Œçš„å‘½ä»¤ï¼ˆå¯é€‰ï¼Œä¸æä¾›åˆ™è¿›å…¥äº¤äº’æ¨¡å¼ï¼‰'
    )
    
    parser.add_argument(
        '-v', '--version',
        action='version',
        version=f'%(prog)s {__version__}'
    )
    
    parser.add_argument(
        '-i', '--interactive',
        action='store_true',
        help='å¼ºåˆ¶è¿›å…¥äº¤äº’æ¨¡å¼'
    )
    
    parser.add_argument(
        '-q', '--quiet',
        action='store_true',
        help='å®‰é™æ¨¡å¼ï¼Œä¸æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯'
    )
    
    parser.add_argument(
        '--no-memory',
        action='store_true',
        help='ç¦ç”¨å¯¹è¯è®°å¿†åŠŸèƒ½'
    )
    
    parser.add_argument(
        '-w', '--working-dir',
        type=str,
        default=os.getcwd(),
        help='è®¾ç½®å·¥ä½œç›®å½•ï¼ˆé»˜è®¤ï¼šå½“å‰ç›®å½•ï¼‰'
    )
    
    return parser.parse_args()


def execute_single_command(command: str, quiet: bool = False) -> int:
    """
    æ‰§è¡Œå•æ¡å‘½ä»¤
    
    Args:
        command: è¦æ‰§è¡Œçš„å‘½ä»¤
        quiet: æ˜¯å¦å®‰é™æ¨¡å¼
    
    Returns:
        é€€å‡ºç ï¼š0è¡¨ç¤ºæˆåŠŸï¼Œ1è¡¨ç¤ºå¤±è´¥
    """
    try:
        # æ„å»ºæ™ºèƒ½ä½“
        agent = build_agent()
        
        if not quiet:
            print(f"\nğŸ¤– æ‰§è¡Œå‘½ä»¤: {command}\n")
        
        # æ„å»ºåˆå§‹çŠ¶æ€
        initial_state: AgentState = {
            "user_input": command,
            "intent": "unknown",
            "command": "",
            "commands": [],
            "command_output": "",
            "command_outputs": [],
            "response": "",
            "error": "",
            "needs_file_creation": False,
            "file_path": "",
            "file_content": "",
            "chat_history": [],
            "mcp_tool": "",
            "mcp_params": {},
            "mcp_result": "",
            "original_input": "",
            "referenced_files": [],
            "file_contents": {},
            # å¾…åŠå­—æ®µä»…åœ¨éœ€è¦æ—¶ç”±èŠ‚ç‚¹å¡«å……ï¼Œä¸é¢„å…ˆåˆå§‹åŒ–
            "todo_action": "",
            "todo_date": "",
            "todo_time": "",
            "todo_content": "",
            "todo_result": ""
        }
        
        # æ‰§è¡Œå·¥ä½œæµ
        result = agent.invoke(initial_state)

        # æ˜¾ç¤ºç»“æœ
        # æ³¨æ„ï¼šé—®ç­”èŠ‚ç‚¹ï¼ˆquestion_answererï¼‰å·²ç»æµå¼æ‰“å°äº†ï¼Œä¸éœ€è¦é‡å¤æ˜¾ç¤º
        intent = result.get('intent', '')

        if quiet:
            # å®‰é™æ¨¡å¼ï¼šåªè¾“å‡ºç»“æœï¼Œä¸å¸¦æ ¼å¼
            if intent != 'question':  # é—®ç­”å·²æµå¼æ‰“å°
                print(result['response'])
        else:
            # éé—®ç­”ç±»å‹éœ€è¦æ ¼å¼åŒ–è¾“å‡º
            if intent not in ['question']:
                print("â”€" * 80)
                print(f"ğŸ¤– åŠ©æ‰‹: {result['response']}")
                print("â”€" * 80)

        # åˆ¤æ–­æ˜¯å¦æˆåŠŸ
        if result.get('error'):
            return 1
        return 0
        
    except KeyboardInterrupt:
        print("\n\nğŸ‘‹ æ‰§è¡Œå·²å–æ¶ˆ\n")
        return 130  # SIGINT
    except Exception as e:
        print(f"\nâŒ é”™è¯¯: {str(e)}\n", file=sys.stderr)
        return 1


def interactive_mode(quiet: bool = False, no_memory: bool = False):
    """
    äº¤äº’æ¨¡å¼
    
    Args:
        quiet: æ˜¯å¦å®‰é™æ¨¡å¼
        no_memory: æ˜¯å¦ç¦ç”¨è®°å¿†
    """
    # æ‰“å°æ¬¢è¿ä¿¡æ¯
    if not quiet:
        print_header()
    
    # æ„å»ºæ™ºèƒ½ä½“
    agent = build_agent()
    
    if not quiet:
        print("ğŸ¬ å‡†å¤‡å°±ç»ªï¼è¯·è¾“å…¥ä½ çš„æŒ‡ä»¤æˆ–é—®é¢˜...\n")
    
    while True:
        try:
            # ä½¿ç”¨æ™ºèƒ½è¾“å…¥å¤„ç†å™¨è·å–ç”¨æˆ·è¾“å…¥
            user_input = smart_input_handler("ğŸ‘¤ ä½ : ")
            
            if not user_input:
                continue
            
            # å¤„ç†ç‰¹æ®Šå‘½ä»¤
            special_result = handle_special_commands(user_input)
            if special_result is True:  # é€€å‡º
                break
            elif special_result is False:  # å·²å¤„ç†ï¼Œç»§ç»­å¾ªç¯
                continue
            
            print()  # ç©ºè¡Œ
            
            # æ„å»ºåˆå§‹çŠ¶æ€
            initial_state: AgentState = {
                "user_input": user_input,
                "intent": "unknown",
                "command": "",
                "commands": [],
                "command_output": "",
                "command_outputs": [],
                "response": "",
                "error": "",
                "needs_file_creation": False,
                "file_path": "",
                "file_content": "",
                "chat_history": [],
                "mcp_tool": "",
                "mcp_params": {},
                "mcp_result": "",
                "original_input": "",
                "referenced_files": [],
                "file_contents": {},
                "todo_action": "",
                "todo_date": "",
                "todo_time": "",
                "todo_content": "",
                "todo_result": ""
            }
            
            # æ‰§è¡Œå·¥ä½œæµ
            result = agent.invoke(initial_state)

            # æ˜¾ç¤ºå“åº”
            # æ³¨æ„ï¼šé—®ç­”èŠ‚ç‚¹å·²ç»æµå¼æ‰“å°ï¼Œå…¶ä»–ç±»å‹éœ€è¦æ ¼å¼åŒ–è¾“å‡º
            intent = result.get('intent', 'unknown')

            if intent not in ['question']:
                print("â”€" * 80)
                print(f"ğŸ¤– åŠ©æ‰‹: {result['response']}")
                print("â”€" * 80 + "\n")
            else:
                # é—®ç­”å·²ç»æµå¼è¾“å‡ºï¼Œåªéœ€è¦ç©ºè¡Œåˆ†éš”
                print()

            # ä¿å­˜åˆ°è®°å¿†ï¼ˆé™¤éç¦ç”¨ï¼‰
            if not no_memory:
                memory.add_interaction(
                    user_input,
                    result['response'],
                    result.get('intent', 'unknown')
                )
            
        except KeyboardInterrupt:
            print("\n\nğŸ‘‹ æ£€æµ‹åˆ°ä¸­æ–­ä¿¡å·ï¼Œé€€å‡ºç¨‹åº...\n")
            break
        except Exception as e:
            print(f"\nâŒ å‘ç”Ÿé”™è¯¯: {str(e)}\n", file=sys.stderr)
            print("è¯·é‡è¯•æˆ–è¾“å…¥ 'exit' é€€å‡º\n")


def main():
    """ä¸»å‡½æ•°"""
    args = parse_arguments()
    
    # è®¾ç½®å·¥ä½œç›®å½•
    if args.working_dir:
        try:
            os.chdir(args.working_dir)
            # åŒæ­¥æ–‡ä»¶å¼•ç”¨è§£æå™¨çš„å·¥ä½œç›®å½•
            update_working_directory(args.working_dir)
            update_selector_working_directory(args.working_dir)
            if not args.quiet:
                print(f"ğŸ“‚ å·¥ä½œç›®å½•: {os.getcwd()}")
        except Exception as e:
            print(f"âŒ æ— æ³•åˆ‡æ¢åˆ°ç›®å½• {args.working_dir}: {e}", file=sys.stderr)
            return 1
    else:
        # ç¡®ä¿æ–‡ä»¶å¼•ç”¨è§£æå™¨ä½¿ç”¨å½“å‰ç›®å½•
        current_dir = os.getcwd()
        update_working_directory(current_dir)
        update_selector_working_directory(current_dir)
    
    # å¦‚æœç¦ç”¨è®°å¿†ï¼Œæ¸…ç©ºè®°å¿†
    if args.no_memory:
        memory.clear()
    
    # åˆ¤æ–­æ¨¡å¼
    if args.command and not args.interactive:
        # å•æ¬¡å‘½ä»¤æ¨¡å¼ - å°†å‘½ä»¤åˆ—è¡¨ç”¨ç©ºæ ¼è¿æ¥
        command_str = ' '.join(args.command)
        exit_code = execute_single_command(command_str, args.quiet)
        return exit_code
    else:
        # äº¤äº’æ¨¡å¼
        interactive_mode(args.quiet, args.no_memory)
        return 0


if __name__ == "__main__":
    sys.exit(main())
