#!/usr/bin/env python3
"""
AIæ™ºèƒ½ä½“ç»ˆç«¯æ§åˆ¶å·¥å…· - CLIç‰ˆæœ¬

ä¸€ä¸ªæ™ºèƒ½çš„ç»ˆç«¯åŠ©æ‰‹ï¼Œæ”¯æŒè‡ªç„¶è¯­è¨€æ‰§è¡Œå‘½ä»¤ã€æ–‡ä»¶æ“ä½œå’Œå¯¹è¯è®°å¿†ã€‚

ä½¿ç”¨ç¤ºä¾‹:
    ai-agent                          # äº¤äº’æ¨¡å¼
    ai-agent "åˆ—å‡ºæ‰€æœ‰Pythonæ–‡ä»¶"     # å•æ¬¡æ‰§è¡Œ
    ai-agent --version                # æŸ¥çœ‹ç‰ˆæœ¬
    ai-agent --help                   # æŸ¥çœ‹å¸®åŠ©
"""

import sys
import os
import argparse
from pathlib import Path

# æ·»åŠ é¡¹ç›®ç›®å½•åˆ°Pythonè·¯å¾„ï¼ˆæ”¯æŒä»ä»»ä½•ä½ç½®è¿è¡Œï¼‰
SCRIPT_DIR = Path(__file__).parent.absolute()
if str(SCRIPT_DIR) not in sys.path:
    sys.path.insert(0, str(SCRIPT_DIR))

from agent_config import AgentState
from agent_memory import memory
from agent_workflow import build_agent
from agent_ui import print_header, handle_special_commands

__version__ = "1.0.0"


def parse_arguments():
    """è§£æå‘½ä»¤è¡Œå‚æ•°"""
    parser = argparse.ArgumentParser(
        prog='ai-agent',
        description='AIæ™ºèƒ½ä½“ç»ˆç«¯æ§åˆ¶å·¥å…· - ä½¿ç”¨è‡ªç„¶è¯­è¨€æ‰§è¡Œç»ˆç«¯å‘½ä»¤',
        epilog='ç¤ºä¾‹: ai-agent "åˆ—å‡ºå½“å‰ç›®å½•çš„æ‰€æœ‰Pythonæ–‡ä»¶"',
        formatter_class=argparse.RawDescriptionHelpFormatter
    )
    
    parser.add_argument(
        'command',
        nargs='?',
        help='è¦æ‰§è¡Œçš„å‘½ä»¤ï¼ˆå¯é€‰ï¼Œä¸æä¾›åˆ™è¿›å…¥äº¤äº’æ¨¡å¼ï¼‰'
    )
    
    parser.add_argument(
        '-v', '--version',
        action='version',
        version=f'%(prog)s {__version__}'
    )
    
    parser.add_argument(
        '-i', '--interactive',
        action='store_true',
        help='å¼ºåˆ¶è¿›å…¥äº¤äº’æ¨¡å¼'
    )
    
    parser.add_argument(
        '-q', '--quiet',
        action='store_true',
        help='å®‰é™æ¨¡å¼ï¼Œä¸æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯'
    )
    
    parser.add_argument(
        '--no-memory',
        action='store_true',
        help='ç¦ç”¨å¯¹è¯è®°å¿†åŠŸèƒ½'
    )
    
    parser.add_argument(
        '-w', '--working-dir',
        type=str,
        default=os.getcwd(),
        help='è®¾ç½®å·¥ä½œç›®å½•ï¼ˆé»˜è®¤ï¼šå½“å‰ç›®å½•ï¼‰'
    )
    
    return parser.parse_args()


def execute_single_command(command: str, quiet: bool = False) -> int:
    """
    æ‰§è¡Œå•æ¡å‘½ä»¤
    
    Args:
        command: è¦æ‰§è¡Œçš„å‘½ä»¤
        quiet: æ˜¯å¦å®‰é™æ¨¡å¼
    
    Returns:
        é€€å‡ºç ï¼š0è¡¨ç¤ºæˆåŠŸï¼Œ1è¡¨ç¤ºå¤±è´¥
    """
    try:
        # æ„å»ºæ™ºèƒ½ä½“
        agent = build_agent()
        
        if not quiet:
            print(f"\nğŸ¤– æ‰§è¡Œå‘½ä»¤: {command}\n")
        
        # æ„å»ºåˆå§‹çŠ¶æ€
        initial_state: AgentState = {
            "user_input": command,
            "intent": "unknown",
            "command": "",
            "commands": [],
            "command_output": "",
            "command_outputs": [],
            "response": "",
            "error": "",
            "needs_file_creation": False,
            "file_path": "",
            "file_content": "",
            "chat_history": [],
            "mcp_tool": "",
            "mcp_params": {},
            "mcp_result": ""
        }
        
        # æ‰§è¡Œå·¥ä½œæµ
        result = agent.invoke(initial_state)
        
        # æ˜¾ç¤ºç»“æœ
        if quiet:
            # å®‰é™æ¨¡å¼ï¼šåªè¾“å‡ºç»“æœï¼Œä¸å¸¦æ ¼å¼
            print(result['response'])
        else:
            print("â”€" * 80)
            print(f"ğŸ¤– åŠ©æ‰‹: {result['response']}")
            print("â”€" * 80)
        
        # åˆ¤æ–­æ˜¯å¦æˆåŠŸ
        if result.get('error'):
            return 1
        return 0
        
    except KeyboardInterrupt:
        print("\n\nğŸ‘‹ æ‰§è¡Œå·²å–æ¶ˆ\n")
        return 130  # SIGINT
    except Exception as e:
        print(f"\nâŒ é”™è¯¯: {str(e)}\n", file=sys.stderr)
        return 1


def interactive_mode(quiet: bool = False, no_memory: bool = False):
    """
    äº¤äº’æ¨¡å¼
    
    Args:
        quiet: æ˜¯å¦å®‰é™æ¨¡å¼
        no_memory: æ˜¯å¦ç¦ç”¨è®°å¿†
    """
    # æ‰“å°æ¬¢è¿ä¿¡æ¯
    if not quiet:
        print_header()
    
    # æ„å»ºæ™ºèƒ½ä½“
    agent = build_agent()
    
    if not quiet:
        print("ğŸ¬ å‡†å¤‡å°±ç»ªï¼è¯·è¾“å…¥ä½ çš„æŒ‡ä»¤æˆ–é—®é¢˜...\n")
    
    while True:
        try:
            # è·å–ç”¨æˆ·è¾“å…¥
            user_input = input("ğŸ‘¤ ä½ : ").strip()
            
            if not user_input:
                continue
            
            # å¤„ç†ç‰¹æ®Šå‘½ä»¤
            special_result = handle_special_commands(user_input)
            if special_result is True:  # é€€å‡º
                break
            elif special_result is False:  # å·²å¤„ç†ï¼Œç»§ç»­å¾ªç¯
                continue
            
            print()  # ç©ºè¡Œ
            
            # æ„å»ºåˆå§‹çŠ¶æ€
            initial_state: AgentState = {
                "user_input": user_input,
                "intent": "unknown",
                "command": "",
                "commands": [],
                "command_output": "",
                "command_outputs": [],
                "response": "",
                "error": "",
                "needs_file_creation": False,
                "file_path": "",
                "file_content": "",
                "chat_history": [],
                "mcp_tool": "",
                "mcp_params": {},
                "mcp_result": ""
            }
            
            # æ‰§è¡Œå·¥ä½œæµ
            result = agent.invoke(initial_state)
            
            # æ˜¾ç¤ºå“åº”
            print("â”€" * 80)
            print(f"ğŸ¤– åŠ©æ‰‹: {result['response']}")
            print("â”€" * 80 + "\n")
            
            # ä¿å­˜åˆ°è®°å¿†ï¼ˆé™¤éç¦ç”¨ï¼‰
            if not no_memory:
                memory.add_interaction(
                    user_input, 
                    result['response'], 
                    result.get('intent', 'unknown')
                )
            
        except KeyboardInterrupt:
            print("\n\nğŸ‘‹ æ£€æµ‹åˆ°ä¸­æ–­ä¿¡å·ï¼Œé€€å‡ºç¨‹åº...\n")
            break
        except Exception as e:
            print(f"\nâŒ å‘ç”Ÿé”™è¯¯: {str(e)}\n", file=sys.stderr)
            print("è¯·é‡è¯•æˆ–è¾“å…¥ 'exit' é€€å‡º\n")


def main():
    """ä¸»å‡½æ•°"""
    args = parse_arguments()
    
    # è®¾ç½®å·¥ä½œç›®å½•
    if args.working_dir:
        try:
            os.chdir(args.working_dir)
            if not args.quiet:
                print(f"ğŸ“‚ å·¥ä½œç›®å½•: {os.getcwd()}")
        except Exception as e:
            print(f"âŒ æ— æ³•åˆ‡æ¢åˆ°ç›®å½• {args.working_dir}: {e}", file=sys.stderr)
            return 1
    
    # å¦‚æœç¦ç”¨è®°å¿†ï¼Œæ¸…ç©ºè®°å¿†
    if args.no_memory:
        memory.clear()
    
    # åˆ¤æ–­æ¨¡å¼
    if args.command and not args.interactive:
        # å•æ¬¡å‘½ä»¤æ¨¡å¼
        exit_code = execute_single_command(args.command, args.quiet)
        return exit_code
    else:
        # äº¤äº’æ¨¡å¼
        interactive_mode(args.quiet, args.no_memory)
        return 0


if __name__ == "__main__":
    sys.exit(main())
