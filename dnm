#!/usr/bin/env python3
"""
DNMæ™ºèƒ½ä½“ç»ˆç«¯æ§åˆ¶å·¥å…· - CLIç‰ˆæœ¬

ä¸€ä¸ªå¼ºå¤§çš„ AI ç»ˆç«¯åŠ©æ‰‹ï¼Œæ”¯æŒè‡ªç„¶è¯­è¨€æ‰§è¡Œå‘½ä»¤ã€æ–‡ä»¶æ“ä½œã€æ•°æ®è½¬æ¢ã€ç¯å¢ƒè¯Šæ–­ã€
å¾…åŠç®¡ç†å’Œå¯¹è¯è®°å¿†ç­‰å¤šç§æ™ºèƒ½åŠŸèƒ½ã€‚

ğŸ¯ æ ¸å¿ƒåŠŸèƒ½:
- ğŸ—£ï¸ è‡ªç„¶è¯­è¨€æ‰§è¡Œå‘½ä»¤ - ç”¨äººè¯è¯´ï¼Œè®© AI æ‰§è¡Œç»ˆç«¯å‘½ä»¤
- ğŸ“ @ æ™ºèƒ½æ–‡ä»¶å¼•ç”¨ - äº¤äº’å¼æ–‡ä»¶é€‰æ‹©å™¨ï¼Œå¿«é€Ÿå¼•ç”¨æ–‡ä»¶
- ğŸ§  å¯¹è¯è®°å¿† - è®°ä½ä¸Šä¸‹æ–‡ï¼Œæ”¯æŒè¿ç»­å¯¹è¯
- ğŸ“ Git æ™ºèƒ½å·¥å…· - è‡ªåŠ¨ç”Ÿæˆ commit æ¶ˆæ¯ã€ä»£ç å®¡æŸ¥
- ğŸ“Š æ•°æ®è½¬æ¢å·¥å…· - JSON/CSV/YAML/XML æ ¼å¼äº’è½¬ã€éªŒè¯
- ğŸ” ç¯å¢ƒè¯Šæ–­ - è‡ªåŠ¨æ£€æµ‹å¼€å‘ç¯å¢ƒé…ç½®å’Œä¾èµ–é—®é¢˜
- ğŸ“‹ å¾…åŠäº‹é¡¹ç®¡ç† - æ™ºèƒ½è¯†åˆ«å¹¶ç®¡ç†æ—¥ç¨‹å®‰æ’å’Œä»»åŠ¡æé†’

ä½¿ç”¨ç¤ºä¾‹:
    # åŸºç¡€åŠŸèƒ½
    dnm                              # äº¤äº’æ¨¡å¼
    dnm "åˆ—å‡ºæ‰€æœ‰Pythonæ–‡ä»¶"          # å•æ¬¡æ‰§è¡Œ
    dnm --help                       # æŸ¥çœ‹è¯¦ç»†å¸®åŠ©

    # æ–‡ä»¶å¼•ç”¨å’Œæ•°æ®è½¬æ¢
    dnm "@README.md è¿™æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ"    # å¼•ç”¨æ–‡ä»¶å¹¶è¯¢é—®
    dnm "@data.json è½¬æ¢ä¸ºCSV"       # æ•°æ®æ ¼å¼è½¬æ¢
    dnm "@config.yaml éªŒè¯æ ¼å¼"      # æ ¼å¼éªŒè¯

    # æ™ºèƒ½åŠŸèƒ½
    dnm "ç”Ÿæˆcommitæ¶ˆæ¯"             # Gitæ™ºèƒ½æäº¤
    dnm "å¯¹å½“å‰ä»£ç è¿›è¡Œcode review"   # ä»£ç å®¡æŸ¥
    dnm "æ£€æŸ¥å¼€å‘ç¯å¢ƒ"               # ç¯å¢ƒè¯Šæ–­

    # å¾…åŠäº‹é¡¹ç®¡ç†
    dnm "ä»Šå¤©18ç‚¹ç»™é™ˆé¾™æ‰“ç”µè¯"        # æ·»åŠ å¾…åŠ
    dnm "æ˜å¤©ä¸Šåˆ10ç‚¹å¼€ä¼š"           # æ·»åŠ å¾…åŠ
    dnm "ä»Šå¤©æœ‰ä»€ä¹ˆè¦åšçš„"            # æŸ¥è¯¢å¾…åŠ
    dnm "æœç´¢é™ˆé¾™ç›¸å…³çš„å¾…åŠ"          # æœç´¢å¾…åŠ
"""

import sys
import os
import argparse
import signal
from pathlib import Path
from typing import Optional

# æ·»åŠ é¡¹ç›®ç›®å½•åˆ°Pythonè·¯å¾„ï¼ˆæ”¯æŒä»ä»»ä½•ä½ç½®è¿è¡Œï¼‰
SCRIPT_DIR = Path(__file__).parent.absolute()
if str(SCRIPT_DIR) not in sys.path:
    sys.path.insert(0, str(SCRIPT_DIR))

from src.core.agent_types import create_initial_state
from src.core.agent_config import AgentStateDict
from src.core.agent_memory import memory
from src.core.agent_workflow import build_agent
from src.ui.agent_ui import print_header, handle_special_commands
from src.ui.file_reference_parser import update_working_directory
from src.ui.interactive_file_selector import update_selector_working_directory
from src.ui.input_handlers import smart_input_handler
from src.core.agent_monitoring import get_monitoring_dashboard

# å°è¯•å¯¼å…¥æ™ºèƒ½æ–‡ä»¶è¾“å…¥ï¼ˆIDE é£æ ¼ï¼‰- ç”¨äºç›®å½•æ›´æ–°
try:
    from src.ui.smart_file_input import update_smart_input_directory
    USE_SMART_INPUT: bool = True
except ImportError:
    USE_SMART_INPUT: bool = False

__version__: str = "1.0.0"


def parse_arguments() -> argparse.Namespace:
    """è§£æå‘½ä»¤è¡Œå‚æ•°"""

    # åˆ›å»ºè¯¦ç»†çš„å¸®åŠ©ä¿¡æ¯
    help_text = """AIæ™ºèƒ½ä½“ç»ˆç«¯æ§åˆ¶å·¥å…· - ä½¿ç”¨è‡ªç„¶è¯­è¨€æ‰§è¡Œç»ˆç«¯å‘½ä»¤

ğŸ¯ æ ¸å¿ƒåŠŸèƒ½:
  ğŸ—£ï¸  è‡ªç„¶è¯­è¨€æ‰§è¡Œå‘½ä»¤    - ç”¨äººè¯è¯´ï¼Œè®© AI æ‰§è¡Œç»ˆç«¯å‘½ä»¤
  ğŸ“  @ æ™ºèƒ½æ–‡ä»¶å¼•ç”¨      - äº¤äº’å¼æ–‡ä»¶é€‰æ‹©å™¨ï¼Œå¿«é€Ÿå¼•ç”¨æ–‡ä»¶
  ğŸ§   å¯¹è¯è®°å¿†           - è®°ä½ä¸Šä¸‹æ–‡ï¼Œæ”¯æŒè¿ç»­å¯¹è¯
  ğŸ“  Git æ™ºèƒ½å·¥å…·       - è‡ªåŠ¨ç”Ÿæˆ commit æ¶ˆæ¯ã€ä»£ç å®¡æŸ¥
  ğŸ“Š  æ•°æ®è½¬æ¢å·¥å…·       - JSON/CSV/YAML/XML æ ¼å¼äº’è½¬ã€éªŒè¯
  ğŸ”  ç¯å¢ƒè¯Šæ–­          - è‡ªåŠ¨æ£€æµ‹å¼€å‘ç¯å¢ƒé…ç½®å’Œä¾èµ–é—®é¢˜
  ğŸ“‹  å¾…åŠäº‹é¡¹ç®¡ç†       - æ™ºèƒ½è¯†åˆ«å¹¶ç®¡ç†æ—¥ç¨‹å®‰æ’å’Œä»»åŠ¡æé†’

ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹:
  åŸºç¡€å‘½ä»¤:
    dnm                              # äº¤äº’æ¨¡å¼
    dnm "åˆ—å‡ºæ‰€æœ‰Pythonæ–‡ä»¶"          # å•æ¬¡æ‰§è¡Œ
    dnm "æ˜¾ç¤ºgitçŠ¶æ€"                # Gitæ“ä½œ
    
  æ–‡ä»¶å¼•ç”¨:
    dnm "@README.md è¿™æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ"    # å¼•ç”¨æ–‡ä»¶å¹¶è¯¢é—®
    dnm "@data.json è½¬æ¢ä¸ºCSV"       # æ•°æ®æ ¼å¼è½¬æ¢
    
  æ™ºèƒ½åŠŸèƒ½:
    dnm "ç”Ÿæˆcommitæ¶ˆæ¯"             # Gitæ™ºèƒ½æäº¤
    dnm "æ£€æŸ¥å¼€å‘ç¯å¢ƒ"               # ç¯å¢ƒè¯Šæ–­
    dnm "ä»Šå¤©18ç‚¹ç»™é™ˆé¾™æ‰“ç”µè¯"        # æ·»åŠ å¾…åŠäº‹é¡¹
    dnm "ä»Šå¤©æœ‰ä»€ä¹ˆè¦åšçš„"            # æŸ¥è¯¢å¾…åŠäº‹é¡¹

ğŸ¨ äº¤äº’æ¨¡å¼ç‰¹æ®Šå‘½ä»¤ (ä»¥ / å¼€å¤´):
    /tools        - æŸ¥çœ‹MCPå·¥å…·åˆ—è¡¨
    /models       - æŸ¥çœ‹åŒLLMé…ç½®
    /files        - æ–‡ä»¶å¼•ç”¨åŠŸèƒ½è¯´æ˜
    /todos        - æŸ¥çœ‹ä»Šæ—¥å¾…åŠ
    /help         - æ˜¾ç¤ºåŠŸèƒ½å¸®åŠ©
    /history      - æŸ¥çœ‹å¯¹è¯å†å²
    /clear        - æ¸…ç©ºå¯¹è¯å†å²
    /exit, /quit  - é€€å‡ºç¨‹åº"""

    parser = argparse.ArgumentParser(
        prog="dnm",
        description=help_text,
        formatter_class=argparse.RawDescriptionHelpFormatter,
    )

    parser.add_argument(
        "command", nargs="*", help="è¦æ‰§è¡Œçš„å‘½ä»¤ï¼ˆå¯é€‰ï¼Œä¸æä¾›åˆ™è¿›å…¥äº¤äº’æ¨¡å¼ï¼‰"
    )

    parser.add_argument(
        "-v", "--version", action="version", version=f"%(prog)s {__version__}"
    )

    parser.add_argument(
        "-i", "--interactive", action="store_true", help="å¼ºåˆ¶è¿›å…¥äº¤äº’æ¨¡å¼"
    )

    parser.add_argument(
        "-q", "--quiet", action="store_true", help="å®‰é™æ¨¡å¼ï¼Œä¸æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯"
    )

    parser.add_argument("--no-memory", action="store_true", help="ç¦ç”¨å¯¹è¯è®°å¿†åŠŸèƒ½")

    parser.add_argument(
        "-w",
        "--working-dir",
        type=str,
        default=os.getcwd(),
        help="è®¾ç½®å·¥ä½œç›®å½•ï¼ˆé»˜è®¤ï¼šå½“å‰ç›®å½•ï¼‰",
    )

    return parser.parse_args()


def execute_single_command(command: str, quiet: bool = False) -> int:
    """
    æ‰§è¡Œå•æ¡å‘½ä»¤

    Args:
        command: è¦æ‰§è¡Œçš„å‘½ä»¤
        quiet: æ˜¯å¦å®‰é™æ¨¡å¼

    Returns:
        é€€å‡ºç ï¼š0è¡¨ç¤ºæˆåŠŸï¼Œ1è¡¨ç¤ºå¤±è´¥
    """
    try:
        # æ„å»ºæ™ºèƒ½ä½“
        agent = build_agent()

        if not quiet:
            print(f"\nğŸ¤– æ‰§è¡Œå‘½ä»¤: {command}\n")

        # æ„å»ºåˆå§‹çŠ¶æ€
        initial_state = create_initial_state(command)

        # æ‰§è¡Œå·¥ä½œæµï¼ˆéœ€è¦è½¬æ¢ä¸ºå­—å…¸æ ¼å¼ï¼‰
        result = agent.invoke(initial_state.to_dict())

        # æ˜¾ç¤ºç»“æœ
        # æ³¨æ„ï¼šé—®ç­”èŠ‚ç‚¹ï¼ˆquestion_answererï¼‰å·²ç»æµå¼æ‰“å°äº†ï¼Œä¸éœ€è¦é‡å¤æ˜¾ç¤º
        intent = result.get("intent", "")

        if quiet:
            # å®‰é™æ¨¡å¼ï¼šåªè¾“å‡ºç»“æœï¼Œä¸å¸¦æ ¼å¼
            if intent != "question":  # é—®ç­”å·²æµå¼æ‰“å°
                print(result["response"])
        else:
            # éé—®ç­”ç±»å‹éœ€è¦æ ¼å¼åŒ–è¾“å‡º
            if intent not in ["question"]:
                print("â”€" * 80)
                print(f"ğŸ¤– åŠ©æ‰‹: {result['response']}")
                print("â”€" * 80)

        # åˆ¤æ–­æ˜¯å¦æˆåŠŸ
        if result.get("error"):
            return 1
        return 0

    except KeyboardInterrupt:
        print("\n\nğŸ‘‹ æ‰§è¡Œå·²å–æ¶ˆ\n")
        return 130  # SIGINT
    except Exception as e:
        print(f"\nâŒ é”™è¯¯: {str(e)}\n", file=sys.stderr)
        return 1


def setup_signal_handlers():
    """è®¾ç½®ä¿¡å·å¤„ç†å™¨"""
    def signal_handler(signum, frame):
        print("\n\nğŸ‘‹ æ”¶åˆ°é€€å‡ºä¿¡å·ï¼Œæ­£åœ¨æ¸…ç†...")
        # åœæ­¢ç›‘æ§ç³»ç»Ÿ
        try:
            dashboard = get_monitoring_dashboard()
            dashboard.stop_monitoring()
        except:
            pass
        print("ğŸ‘‹ ç¨‹åºå·²é€€å‡º")
        sys.exit(0)
    
    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)


def interactive_mode(quiet: bool = False, no_memory: bool = False) -> None:
    """
    äº¤äº’æ¨¡å¼

    Args:
        quiet: æ˜¯å¦å®‰é™æ¨¡å¼
        no_memory: æ˜¯å¦ç¦ç”¨è®°å¿†
    """
    # è®¾ç½®ä¿¡å·å¤„ç†å™¨
    setup_signal_handlers()
    
    # å¯åŠ¨ç›‘æ§ç³»ç»Ÿ
    dashboard = get_monitoring_dashboard()
    dashboard.start_monitoring()
    
    # æ‰“å°æ¬¢è¿ä¿¡æ¯
    if not quiet:
        print_header()

    # æ„å»ºæ™ºèƒ½ä½“
    agent = build_agent()

    if not quiet:
        print("ğŸ¬ å‡†å¤‡å°±ç»ªï¼è¯·è¾“å…¥ä½ çš„æŒ‡ä»¤æˆ–é—®é¢˜...\n")

    while True:
        try:
            # ä½¿ç”¨æ™ºèƒ½è¾“å…¥å¤„ç†å™¨è·å–ç”¨æˆ·è¾“å…¥
            user_input = smart_input_handler("ğŸ‘¤ ä½ : ")

            if not user_input:
                continue

            # å¤„ç†ç‰¹æ®Šå‘½ä»¤
            special_result = handle_special_commands(user_input)
            if special_result is True:  # é€€å‡º
                break
            elif special_result is False:  # å·²å¤„ç†ï¼Œç»§ç»­å¾ªç¯
                continue

            print()  # ç©ºè¡Œ

            # æ„å»ºåˆå§‹çŠ¶æ€
            initial_state = create_initial_state(user_input)

            # æ‰§è¡Œå·¥ä½œæµï¼ˆéœ€è¦è½¬æ¢ä¸ºå­—å…¸æ ¼å¼ï¼‰
            result = agent.invoke(initial_state.to_dict())

            # æ˜¾ç¤ºå“åº”
            # æ³¨æ„ï¼šé—®ç­”èŠ‚ç‚¹å·²ç»æµå¼æ‰“å°ï¼Œå…¶ä»–ç±»å‹éœ€è¦æ ¼å¼åŒ–è¾“å‡º
            intent = result.get("intent", "unknown")

            if intent not in ["question"]:
                print("â”€" * 80)
                print(f"ğŸ¤– åŠ©æ‰‹: {result['response']}")
                print("â”€" * 80 + "\n")
            else:
                # é—®ç­”å·²ç»æµå¼è¾“å‡ºï¼Œåªéœ€è¦ç©ºè¡Œåˆ†éš”
                print()

            # ä¿å­˜åˆ°è®°å¿†ï¼ˆé™¤éç¦ç”¨ï¼‰
            if not no_memory:
                memory.add_interaction(
                    user_input, result["response"], result.get("intent", "unknown")
                )

        except KeyboardInterrupt:
            print("\n\nğŸ‘‹ æ£€æµ‹åˆ°ä¸­æ–­ä¿¡å·ï¼Œé€€å‡ºç¨‹åº...\n")
            break
        except Exception as e:
            print(f"\nâŒ å‘ç”Ÿé”™è¯¯: {str(e)}\n", file=sys.stderr)
            print("è¯·é‡è¯•æˆ–è¾“å…¥ 'exit' é€€å‡º\n")
    
    # åœæ­¢ç›‘æ§ç³»ç»Ÿ
    try:
        dashboard.stop_monitoring()
    except KeyboardInterrupt:
        # å¦‚æœåœ¨åœæ­¢ç›‘æ§æ—¶å†æ¬¡è¢«ä¸­æ–­ï¼Œç›´æ¥é€€å‡º
        print("ğŸ‘‹ ç¨‹åºå·²é€€å‡º")
    except Exception as e:
        print(f"âš ï¸ åœæ­¢ç›‘æ§æ—¶å‡ºç°é—®é¢˜: {e}")
        # ç»§ç»­é€€å‡ºï¼Œä¸é˜»å¡ç¨‹åº


def main() -> int:
    """ä¸»å‡½æ•°"""
    args = parse_arguments()

    # è®¾ç½®å·¥ä½œç›®å½•
    if args.working_dir:
        try:
            os.chdir(args.working_dir)
            # åŒæ­¥æ–‡ä»¶å¼•ç”¨è§£æå™¨çš„å·¥ä½œç›®å½•
            update_working_directory(args.working_dir)
            update_selector_working_directory(args.working_dir)
            if USE_SMART_INPUT:
                update_smart_input_directory(args.working_dir)
            if not args.quiet:
                print(f"ğŸ“‚ å·¥ä½œç›®å½•: {os.getcwd()}")
        except Exception as e:
            print(f"âŒ æ— æ³•åˆ‡æ¢åˆ°ç›®å½• {args.working_dir}: {e}", file=sys.stderr)
            return 1
    else:
        # ç¡®ä¿æ–‡ä»¶å¼•ç”¨è§£æå™¨ä½¿ç”¨å½“å‰ç›®å½•
        current_dir = os.getcwd()
        update_working_directory(current_dir)
        update_selector_working_directory(current_dir)
        if USE_SMART_INPUT:
            update_smart_input_directory(current_dir)

    # å¦‚æœç¦ç”¨è®°å¿†ï¼Œæ¸…ç©ºè®°å¿†
    if args.no_memory:
        memory.clear()

    # åˆ¤æ–­æ¨¡å¼
    if args.command and not args.interactive:
        # å•æ¬¡å‘½ä»¤æ¨¡å¼ - å°†å‘½ä»¤åˆ—è¡¨ç”¨ç©ºæ ¼è¿æ¥
        command_str = " ".join(args.command)
        exit_code = execute_single_command(command_str, args.quiet)
        return exit_code
    else:
        # äº¤äº’æ¨¡å¼
        interactive_mode(args.quiet, args.no_memory)
        return 0


if __name__ == "__main__":
    sys.exit(main())
