---
description: @ 文件引用功能开发指南 v1.1.0
---

# @ 文件引用功能指南

## 核心模块

### 新架构 (v1.1.0)
- **[smart_file_input.py](mdc:smart_file_input.py)** - 智能文件输入处理器（主模块）
  - `FileCompleter` - 自动补全器（prompt-toolkit）
  - `SmartFileInput` - 智能输入管理器
  - 增强模式 + 降级模式

### 传统模块（保留）
- **[file_reference_parser.py](mdc:file_reference_parser.py)** - @ 语法解析和文件内容读取
- **[interactive_file_selector.py](mdc:interactive_file_selector.py)** - 传统交互式文件选择器

### 入口集成
- **[ai-agent](mdc:ai-agent)** - `smart_input_handler()` 函数
- **[dnm](mdc:dnm)** - `smart_input_handler()` 函数

## 工作流程

### 新流程（增强模式）

```python
# 1. 用户输入 @
👤 你: @

# 2. 立即触发 FileCompleter
def get_completions(document, complete_event):
    # 检测 @ 符号
    match = re.search(r'@([^\s]*)$', text)
    # 返回补全建议

# 3. 显示补全菜单（自动）
- 深色主题
- 蓝色高亮
- 实时过滤

# 4. 用户选择文件
↑↓ 导航，Enter 确认

# 5. 继续对话
👤 你: @agent_config.py 这是做什么的？
```

### 降级流程（无 prompt-toolkit）

```python
# 1. 用户输入包含 @
👤 你: @agent

# 2. 检测并搜索
if '@' in user_input:
    matches = _simple_file_search(query)

# 3. 显示弹出选择框
if len(matches) > 1:
    _show_popup_selector(matches, query)

# 4. 用户选择
数字/Enter/s

# 5. 替换为完整文件名
result = "@agent_config.py ..."
```

## 关键函数

### smart_file_input.py

```python
class FileCompleter(Completer):
    """自动补全器"""
    
    def get_completions(document, complete_event):
        """实时生成补全建议"""
        # 检测 @ 符号
        # 模糊匹配文件
        # 返回 Completion 对象

class SmartFileInput:
    """智能输入管理器"""
    
    def get_input(prompt_text) -> str:
        """获取用户输入（带自动补全）"""
        # 增强模式：使用 prompt-toolkit
        # 降级模式：传统输入
    
    def _fallback_input(prompt_text) -> str:
        """降级输入处理"""
        # 检测 @ 符号
        # 显示弹出选择
```

### 集成点（dnm / ai-agent）

```python
def smart_input_handler(prompt: str = "👤 你: ") -> str:
    """智能输入处理器"""
    # 检查 prompt-toolkit 可用性
    if check_prompt_toolkit_available():
        # 使用增强模式
        return get_smart_input(prompt)
    else:
        # 降级到传统模式
        # 保留原有的文件选择器逻辑
```

## 样式配置

### 自定义主题

```python
custom_style = Style.from_dict({
    'completion-menu': 'bg:#1e1e1e #ffffff',
    'completion-menu.completion.current': 'bg:#0066cc #ffffff bold',
    'scrollbar.background': 'bg:#1e1e1e',
})
```

### 补全菜单配置

```python
prompt(
    completer=self.completer,
    complete_while_typing=True,  # 立即显示
    style=custom_style,
    complete_style='MULTI_COLUMN',
    reserve_space_for_menu=8,  # 预留空间
)
```

## 文件图标映射

```python
icon_map = {
    '.py': '🐍',
    '.js': '🟨',
    '.md': '📝',
    '.json': '📋',
    '.yml': '⚙️',
    # 目录使用 📁
}
```

## 模糊匹配算法

```python
def _fuzzy_match(query: str, text: str) -> Tuple[bool, int]:
    """
    返回 (是否匹配, 得分)
    
    得分规则:
    - 精确匹配: 100
    - 前缀匹配: 90
    - 包含匹配: 70
    - 顺序匹配: 50
    """
```

## 性能优化

### 文件缓存

```python
def _refresh_file_cache(self):
    """扫描并缓存文件列表"""
    # 递归扫描（深度3层）
    # 忽略隐藏文件和特定目录
    # 缓存文件信息
```

### 忽略规则

```python
# 自动忽略
- .git/
- node_modules/
- __pycache__/
- venv/
- 隐藏文件（.开头）
```

## 错误处理

```python
try:
    # 尝试使用增强模式
    result = prompt(...)
except Exception as e:
    # 自动降级
    print(f"⚠️  降级到简单模式: {e}")
    return self._fallback_input(prompt_text)
```

## 测试

### 单元测试
```bash
python test_smart_file_input.py
```

### 交互测试
```bash
python demo_smart_file_input.py
python quick_test_autocomplete.py
```

## 扩展建议

### 未来功能
- [ ] 文件预览（显示前几行）
- [ ] Git 状态显示
- [ ] 最近使用文件优先
- [ ] 收藏文件功能
- [ ] 正则表达式搜索

### 样式主题
- [ ] 浅色主题选项
- [ ] 自定义颜色配置
- [ ] 字体大小调整

## 依赖

### 必需
- `pathlib` - 路径处理
- `re` - 正则匹配

### 可选（增强功能）
- `prompt-toolkit>=3.0.0` - IDE 风格补全

## 配置管理

所有配置在 `smart_file_input.py` 中：

```python
max_depth = 3  # 扫描深度
max_results = 30  # 结果数量
reserve_space_for_menu = 8  # 菜单空间
```

## 文档

- [UPGRADE_GUIDE.md](mdc:../UPGRADE_GUIDE.md) - 升级指南
- [docs/SMART_FILE_REFERENCE.md](mdc:../docs/SMART_FILE_REFERENCE.md) - 完整文档
- [FILE_REFERENCE_UPGRADE_SUMMARY.md](mdc:../FILE_REFERENCE_UPGRADE_SUMMARY.md) - 升级总结
